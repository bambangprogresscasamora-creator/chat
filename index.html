<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chat Bareng â€” HTML Only</title>
  <style>
    :root{
      --bg:#0b141a; --chat:#111b21; --mine:#005c4b; --theirs:#202c33; --text:#e9edef; --muted:#8696a0; --accent:#25d366; --line:#2a3942;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;display:grid;grid-template-rows:auto 1fr auto}
    header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--chat);border-bottom:1px solid var(--line)}
    .title{font-weight:700}
    .me{margin-left:auto;font-size:14px;color:var(--muted)}
    .dropdown{position:relative}
    .menu{margin-left:8px;border:1px solid var(--line);background:transparent;color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
    .dropdown-content{display:none;position:absolute;right:0;margin-top:8px;background:var(--chat);border:1px solid var(--line);min-width:220px;border-radius:12px;overflow:hidden;z-index:20}
    .dropdown-content button{width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;color:var(--text);cursor:pointer}
    .dropdown-content button:hover{background:#0e171c}
    .show{display:block}

    #list{padding:10px;background:var(--bg);overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:min(80%,720px);padding:8px 10px;border-radius:12px;position:relative;word-wrap:break-word;white-space:pre-wrap}
    .mine{align-self:flex-end;background:var(--mine)}
    .theirs{align-self:flex-start;background:var(--theirs)}
    .name{font-weight:600;margin-bottom:4px;font-size:14px}
    .meta{display:flex;justify-content:flex-end;gap:8px;font-size:12px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;background:var(--accent);color:#063b2a;border-radius:8px;padding:2px 6px;font-weight:700;margin-left:6px}
    .sys{align-self:center;color:var(--muted);font-size:12px;margin:8px 0}

    #inputBar{display:flex;gap:8px;padding:10px;background:var(--chat);border-top:1px solid var(--line)}
    #msg{flex:1;padding:12px 14px;border-radius:20px;border:1px solid var(--line);background:#0c1317;color:#e9edef;font-size:16px}
    #send{padding:10px 16px;border-radius:20px;border:none;background:var(--accent);color:#083b2a;font-weight:700;cursor:pointer}

    @media (max-width:480px){ body{font-size:18px} #msg{font-size:18px} }
    #list::-webkit-scrollbar{width:10px} #list::-webkit-scrollbar-thumb{background:var(--line);border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div class="title">ðŸ’¬ Chat Bareng <span id="modeBadge" style="font-size:12px;margin-left:8px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;opacity:.85"></span></div>
    <div class="me" id="meLabel">Nama: -</div>
    <div class="dropdown">
      <button class="menu" id="menuBtn">â˜°</button>
      <div class="dropdown-content" id="menuPanel">
        <button id="gantiNama">Ganti Nama</button>
        <button id="gantiRuang">Ganti Ruang/Room</button>
        <button id="salinLink">Salin Link Room</button>
        <button id="simpanTxt">Simpan Percakapan (.txt)</button>
        <button id="salinSemua">Salin Semua ke Clipboard</button>
        <button id="hapusKu">Bersihkan Tampilan Lokal</button>
      </div>
    </div>
  </header>

  <div id="list"></div>

  <div id="inputBar">
    <input id="msg" placeholder="Tulis pesanâ€¦" autocomplete="off" />
    <button id="send">Kirim</button>
  </div>

  <script>
    // ===== Konfigurasi Firebase (opsional). Jika dibiarkan PASTE_..., aplikasi otomatis jalan dalam MODE DEMO (tanpa Firebase) =====
   const firebaseConfig = {
  apiKey: "AIzaSyBvLYsdcQbaS37udt-UaDGfmuFR2-lMIxM",
  authDomain: "chating-84a2c.firebaseapp.com",
  projectId: "chating-84a2c",
  storageBucket: "chating-84a2c.firebasestorage.app",
  messagingSenderId: "245740844693",
  appId: "1:245740844693:web:04d86c550bed384546cd9c",
  measurementId: "G-S3EWTC7160"
};
    const HAS_FB = firebaseConfig.apiKey && !String(firebaseConfig.apiKey).startsWith('PASTE');

    // ===== Util & State =====
    const $ = sel => document.querySelector(sel);
    const list = $("#list");
    const msg  = $("#msg");
    const send = $("#send");
    const meLabel = $("#meLabel");
    const menuBtn = $("#menuBtn");
    const menuPanel = $("#menuPanel");

    let messagesCache = []; // selalu sinkron dengan UI untuk operasi sinkron (clipboard)

    function sanitizeRoom(r){ return (r||'').toString().trim().toLowerCase().replace(/[^a-z0-9-_]/g,'-') || 'umum'; }
    function getRoom(){
      const url = new URL(location.href);
      const q = url.searchParams.get('room');
      const stored = localStorage.getItem('CHAT_ROOM');
      return sanitizeRoom(q || stored || 'umum');
    }
    function setRoom(r){
      const norm = sanitizeRoom(r);
      localStorage.setItem('CHAT_ROOM', norm);
      const url = new URL(location.href);
      url.searchParams.set('room', norm);
      location.href = url.toString();
    }`; }

    let ROOM = getRoom();
    let NAME = localStorage.getItem("CHAT_NAME") || "";
    meLabel.textContent = `Nama: ${NAME || '-'}`;

    function askName(){
      const n = prompt("Masukkan nama (tanpa login):", NAME || "");
      if(n && n.trim()){
        NAME = n.trim();
        localStorage.setItem("CHAT_NAME", NAME);
        meLabel.textContent = "Nama: " + NAME;
      }
    }
    if(!NAME) askName();

    function fmtTime(date){
      const hh = String(date.getHours()).padStart(2,'0');
      const mm = String(date.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function addBubble(m, mine=false){
      const wrap = document.createElement('div');
      wrap.className = 'bubble ' + (mine ? 'mine' : 'theirs');
      if(!mine){
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = m.name || 'Anon';
        wrap.appendChild(nm);
      }
      const text = document.createElement('div');
      text.textContent = m.text;
      wrap.appendChild(text);

      const meta = document.createElement('div');
      meta.className = 'meta';
      const d = m.ts instanceof Date ? m.ts : new Date(m.ts || Date.now());
      const time = document.createElement('span');
      time.textContent = fmtTime(d);
      meta.appendChild(time);
      if(mine){
        const you = document.createElement('span');
        you.className = 'badge';
        you.textContent = 'You';
        meta.appendChild(you);
      }
      wrap.appendChild(meta);

      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
    }

    function systemLine(t){
      const s = document.createElement('div');
      s.className = 'sys';
      s.textContent = t;
      list.appendChild(s);
      list.scrollTop = list.scrollHeight;
    }

    // ===== Transport Abstraction (DEMO vs Firebase) =====
    class DemoTransport{ // HANYA LOKAL/SE-PERANGKAT
      constructor(room){
        this.room = room;
        this.key = `messages/${room}`;
        this.supportsBC = false;
        try{ this.supportsBC = !!window.BroadcastChannel; }catch{ this.supportsBC = false; }
        if(this.supportsBC){
          try{ this.bc = new BroadcastChannel(`chat-room-${room}`); }catch{ this.supportsBC=false; }
        }
        // fallback via localStorage 'storage' event
        window.addEventListener('storage', (e)=>{
          if(e.key === `chat-emit-${this.room}` && e.newValue){
            try{ const m = JSON.parse(e.newValue); messagesCache.push(m); addBubbleProxy(m); }catch{}
          }
        });
      }
      _get(){ try{ return JSON.parse(localStorage.getItem(this.key)||'[]'); }catch{ return []; } }
      _set(arr){ localStorage.setItem(this.key, JSON.stringify(arr)); }
      listen(cb){
        systemLine(`Ruang: ${this.room} (DEMO mode â€” tidak realtime lintas perangkat). Gunakan Firebase agar sinkron antar HP/PC.`);
        systemLine(`Path: rooms/${this.room}`);
        // initial
        const arr = this._get();
        messagesCache = [];
        arr.forEach(m=>{ messagesCache.push(m); cb(m); });
        // listen broadcast (antar tab)
        if(this.supportsBC){
          this.bc.onmessage = (ev)=>{ if(ev.data && ev.data.type==='new'){ messagesCache.push(ev.data.msg); cb(ev.data.msg); } };
        }
      }
      async send(name, text){
        const m = { name, text, ts: Date.now() };
        const arr = this._get(); arr.push(m); this._set(arr);
        messagesCache.push(m); // pastikan tab ini juga update
        addBubbleProxy(m);
        if(this.supportsBC){ this.bc.postMessage({type:'new', msg:m}); }
        else {
          // trigger untuk tab lain
          localStorage.setItem(`chat-emit-${this.room}`, JSON.stringify(m));
          setTimeout(()=> localStorage.removeItem(`chat-emit-${this.room}`), 0);
        }
        return true;
      }
      async exportAll(){ return this._get(); }
    }

    class FirebaseTransport{
      constructor(room){ this.room = room; this.db = null; this.unsub = null; }
      async _ensure(){
        if(this.db) return;
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js');
        if(!firebase.apps || !firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
        this.db = firebase.firestore();
      }
      async listen(cb){
        await this._ensure();
        systemLine(`Ruang: ${this.room}`);
        if (firebaseConfig && firebaseConfig.projectId) systemLine(`Project: ${firebaseConfig.projectId} â€¢ Path: rooms/${this.room}`);
        this.unsub = this.db.collection('rooms').doc(this.room).collection('messages')
          .orderBy('ts','asc').limit(500)
          .onSnapshot(snap=>{
            list.innerHTML = '';
            messagesCache = [];
            snap.forEach(doc=>{
              const m = doc.data();
              let ts = Date.now();
              const v = m.ts;
              if(v && typeof v === 'object' && typeof v.toDate === 'function'){ ts = v.toDate().getTime(); }
              else if(typeof v === 'number'){ ts = v; }
              const norm = { name:m.name, text:m.text, ts };
              messagesCache.push(norm);
              cb(norm);
            });
          }, err=>{
            console.error(err);
            systemLine('Gagal konek Firestore (cek config/rules). Beralih ke DEMO.');
            transport = new DemoTransport(ROOM);
            transport.listen(addBubbleProxy);
          });
      }
      async send(name, text){
        await this._ensure();
        await this.db.collection('rooms').doc(this.room).collection('messages').add({
          name, text, ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      async exportAll(){
        await this._ensure();
        const qs = await this.db.collection('rooms').doc(this.room).collection('messages').orderBy('ts','asc').get();
        const arr = [];
        qs.forEach(doc=>{
          const m = doc.data();
          let ts = Date.now();
          const v = m.ts;
          if(v && typeof v === 'object' && typeof v.toDate === 'function'){ ts = v.toDate().getTime(); }
          else if(typeof v === 'number'){ ts = v; }
          arr.push({name:m.name, text:m.text, ts});
        });
        return arr;
      }
    }

    function loadScript(src){
      return new Promise((res, rej)=>{
        const s = document.createElement('script'); s.src = src; s.onload = res; s.onerror = ()=>rej(new Error('load fail '+src));
        document.head.appendChild(s);
      });
    }

    let transport = HAS_FB ? new FirebaseTransport(ROOM) : new DemoTransport(ROOM);

    // Update badge mode di header
    const modeBadge = document.getElementById('modeBadge');
    function setBadge(txt, bg){ modeBadge.textContent = txt; modeBadge.style.background = bg; }
    if(HAS_FB){ setBadge('FIREBASE (online)', '#134e4a'); }
    else { setBadge('DEMO (lokal)', '#3f3f46'); }

    function addBubbleProxy(m){ addBubble(m, m.name === NAME); }
    transport.listen(addBubbleProxy);

    // ===== Kirim pesan =====
    async function sendMsg(){
      const t = msg.value.trim();
      if(!t) return;
      if(!NAME) askName();
      await transport.send(NAME || 'Anon', t);
      msg.value = '';
      msg.focus();
    }
    send.addEventListener('click', sendMsg);
    msg.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMsg(); });
    list.addEventListener('click', ()=> msg.focus());

    // ===== Build teks sinkron dari cache =====
    function buildLinesFromCache(){
      return (messagesCache||[]).map(m=>{
        const d = new Date(m.ts||Date.now());
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `[${hh}:${mm}] ${m.name}: ${m.text}`;
      });
    }

    // ===== Copy aman (user gesture only) =====
    async function copyTextSafely(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text); // harus dipanggil langsung dari event handler
          return {ok:true, method:'clipboard'};
        }
        throw new Error('Clipboard API tidak tersedia atau context tidak aman');
      }catch(err){
        try{
          // Fallback: execCommand('copy')
          const ta = document.createElement('textarea');
          ta.value = text; ta.setAttribute('readonly','');
          ta.style.position = 'fixed'; ta.style.top = '-1000px';
          document.body.appendChild(ta);
          ta.select(); ta.setSelectionRange(0, ta.value.length);
          const ok = document.execCommand && document.execCommand('copy');
          document.body.removeChild(ta);
          if(ok) return {ok:true, method:'execCommand'};
          throw new Error('execCommand copy gagal');
        }catch(err2){
          return {ok:false, error: err.message + ' / ' + err2.message};
        }
      }
    }

    // ===== MENU =====
    menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menuPanel.classList.toggle('show'); });
    document.addEventListener('click', ()=> menuPanel.classList.remove('show'));

    $('#gantiNama').onclick = ()=> { askName(); menuPanel.classList.remove('show'); };
    $('#gantiRuang').onclick = ()=>{
      const r = prompt('Nama room/ruang?', ROOM);
      if(r && r.trim()) setRoom(r.trim());
    };
    $('#salinLink').onclick = ()=>{
      const url = new URL(location.href);
      url.searchParams.set('room', ROOM);
      const u = url.toString();
      const ta = document.createElement('textarea'); ta.value = u; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('Link room disalin: ' + u);
      menuPanel.classList.remove('show');
    };
      if(r && r.trim()) setRoom(r.trim());
    };
    $('#hapusKu').onclick = ()=>{ list.innerHTML = ''; alert('Tampilan lokal dibersihkan.'); menuPanel.classList.remove('show'); };

    // ===== Simpan percakapan (.txt) =====
    async function exportLines(){
      const arr = await transport.exportAll();
      return (arr||[]).map(m=>{
        const d = new Date(m.ts||Date.now());
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `[${hh}:${mm}] ${m.name}: ${m.text}`;
      });
    }
    $('#simpanTxt').onclick = async ()=>{
      const txt = (await exportLines()).join('\n') || '(belum ada percakapan)';
      const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `percakapan_${ROOM}.txt`; a.click();
      URL.revokeObjectURL(url);
      menuPanel.classList.remove('show');
    };

    // ===== Salin semua ke Clipboard (tanpa await sebelum copy) =====
    $('#salinSemua').onclick = async ()=>{
      // bangun teks sinkron agar user-activation tidak hilang
      const txt = (buildLinesFromCache()).join('\n') || '(belum ada percakapan)';
      const res = await copyTextSafely(txt);
      if(res.ok){
        alert(`Percakapan disalin (metode: ${res.method}).`);
      } else {
        // Fallback terakhir: unduh file agar user tetap dapat menyalin
        const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `percakapan_${ROOM}.txt`; a.click();
        URL.revokeObjectURL(url);
        alert('Clipboard diblokir oleh Permissions Policy atau context tidak aman. File .txt diunduh sebagai fallback.');
      }
      menuPanel.classList.remove('show');
    };

    // ====== SELF-TESTS ======
    (function runSelfTests(){
      try{
        // Test 1: newline join must be "\n"
        const t1 = ['A','B'].join('\n') === 'A\nB';
        if(!t1) throw new Error('Join newline gagal');

        // Test 2: addBubble tidak error
        addBubble({name:'Test', text:'Halo', ts:Date.now()}, false);

        // Test 3: DemoTransport simpan/ambil
        const rt = 'rt_'+Math.random().toString(36).slice(2);
        const dt = new DemoTransport(rt);
        dt.send('Uji','Pesan');
        dt.exportAll().then(arr=>{
          if(!arr || !arr.length) console.warn('Self-test: exportAll kosong (ok jika private mode).');
        });

        // Test 4: buildLinesFromCache menghasilkan baris
        messagesCache.push({name:'A', text:'x', ts:Date.now()});
        messagesCache.push({name:'B', text:'y', ts:Date.now()});
        const lines = buildLinesFromCache();
        if(!(Array.isArray(lines) && lines.length>=2)) throw new Error('buildLinesFromCache gagal');

        // Test 5: copyTextSafely mengembalikan Promise object
        const p = copyTextSafely('test');
        if(!(p && typeof p.then==='function')) throw new Error('copyTextSafely bukan Promise');

        console.log('Self-tests passed.');
        // Test 6: mode badge terpasang
        if(!document.getElementById('modeBadge').textContent) throw new Error('Mode badge tidak terpasang');
      }catch(e){ console.warn('Self-tests warning:', e.message); }
    })();
  </script>

  <!--
  ===================== PETUNJUK CEPAT =====================
  â€¢ Tanpa isi Firebase â†’ otomatis jalan MODE DEMO (tab yang sama origin bisa chat via BroadcastChannel/localStorage). Cocok buat test/preview.
  â€¢ Isi firebaseConfig â†’ realtime multi-user lintas perangkat via Firestore.

  1) Buat project Firebase â†’ aktifkan Firestore.
  2) Ambil firebaseConfig dan ganti placeholder di atas (agar keluar dari DEMO mode).
  3) Jalankan via server lokal (contoh):
       python -m http.server 5500
     lalu buka http://127.0.0.1:5500
  4) Akses dari HP/PC satu Wiâ€‘Fi dan pakai parameter ?room=nama.

  âš ï¸ Catatan Clipboard: Chrome/Edge/Firefox modern mensyaratkan context aman (HTTPS atau http://localhost). Di environment yang menerapkan Permissions Policy ketat (mis. sandbox/iframe), clipboard bisa diblokir; tombol akan otomatis fallback ke unduh .txt.

  **Rules contoh DEV (longgar, hanya untuk percobaan):**
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /rooms/{room}/messages/{msg} {
        allow read, write: if true; // DEV SAJA
      }
    }
  }
  ==========================================================
  -->
</body>
</html>
