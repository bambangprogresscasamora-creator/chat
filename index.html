<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Chat Bareng â€” HTML Only</title>
  <style>
    :root{
      --bg:#0b141a; --chat:#111b21; --mine:#005c4b; --theirs:#202c33; --text:#e9edef; --muted:#8696a0; --accent:#25d366; --line:#2a3942;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;display:grid;grid-template-rows:auto 1fr auto}
    header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--chat);border-bottom:1px solid var(--line)}
    .title{font-weight:700}
    .me{margin-left:auto;font-size:14px;color:var(--muted)}
    .dropdown{position:relative}
    .menu{margin-left:8px;border:1px solid var(--line);background:transparent;color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
    .dropdown-content{display:none;position:absolute;right:0;margin-top:8px;background:var(--chat);border:1px solid var(--line);min-width:240px;border-radius:12px;overflow:hidden;z-index:20}
    .dropdown-content button{width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;color:var(--text);cursor:pointer}
    .dropdown-content button:hover{background:#0e171c}
    .show{display:block}

    #list{padding:10px;background:var(--bg);overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:min(80%,720px);padding:8px 10px;border-radius:12px;position:relative;word-wrap:break-word;white-space:pre-wrap}
    .mine{align-self:flex-end;background:var(--mine)}
    .theirs{align-self:flex-start;background:var(--theirs)}
    .name{font-weight:600;margin-bottom:4px;font-size:14px}
    .meta{display:flex;justify-content:flex-end;gap:8px;font-size:12px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;background:var(--accent);color:#063b2a;border-radius:8px;padding:2px 6px;font-weight:700;margin-left:6px}
    .sys{align-self:center;color:var(--muted);font-size:12px;margin:8px 0}

    #inputBar{display:flex;gap:8px;padding:10px;background:var(--chat);border-top:1px solid var(--line)}
    #msg{flex:1;padding:12px 14px;border-radius:20px;border:1px solid var(--line);background:#0c1317;color:#e9edef;font-size:16px}
    #send{padding:10px 16px;border-radius:20px;border:none;background:var(--accent);color:#083b2a;font-weight:700;cursor:pointer}

    @media (max-width:480px){ body{font-size:18px} #msg{font-size:18px} }
    #list::-webkit-scrollbar{width:10px} #list::-webkit-scrollbar-thumb{background:var(--line);border-radius:10px}
    body[data-pending="1"] header::after{content:"menyimpanâ€¦";margin-left:10px;color:#93c5fd;font-size:12px}

    #overlayBusy{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    #overlayBusy span{background:#0e171c;border:1px solid var(--line);padding:10px 14px;border-radius:12px;color:#cbd5e1;font:14px system-ui}
  </style>
</head>
<body>
  <header>
    <div class="title">ðŸ’¬ Chat Bareng <span id="modeBadge" style="font-size:12px;margin-left:8px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;opacity:.85"></span></div>
    <div class="me" id="meLabel">Nama: -</div>
    <div class="dropdown">
      <button class="menu" id="menuBtn">â˜°</button>
      <div class="dropdown-content" id="menuPanel">
        <button id="gantiNama">Ganti Nama</button>
        <button id="gantiRuang">Ganti Ruang/Room</button>
        <button id="salinLink">Salin Link Room</button>
        <button id="simpanTxt">Simpan Percakapan (.txt)</button>
        <button id="salinSemua">Salin Semua ke Clipboard</button>
        <button id="hapusRoom">Hapus semua pesan di room ini</button>
        <button id="hapusKu">Bersihkan Tampilan Lokal</button>
      </div>
    </div>
  </header>

  <div id="list"></div>

  <div id="inputBar">
    <input id="msg" placeholder="Tulis pesanâ€¦" autocomplete="off" />
    <button id="send">Kirim</button>
  </div>

  <div id="debugBar" style="position:fixed;bottom:6px;left:6px;font:12px system-ui;background:rgba(32,44,51,.9);border:1px solid var(--line);border-radius:8px;padding:6px 8px;color:#cbd5e1;display:none"></div>
  <div id="overlayBusy"><span>Memprosesâ€¦</span></div>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyBvLYsdcQbaS37udt-UaDGfmuFR2-lMIxM",
  authDomain: "chating-84a2c.firebaseapp.com",
  projectId: "chating-84a2c",
  storageBucket: "chating-84a2c.firebasestorage.app",
  messagingSenderId: "245740844693",
  appId: "1:245740844693:web:04d86c550bed384546cd9c",
  measurementId: "G-S3EWTC7160"
};
    const HAS_FB = firebaseConfig.apiKey && !String(firebaseConfig.apiKey).startsWith('PASTE');

    const $ = sel => document.querySelector(sel);
    const list = $("#list");
    const msg  = $("#msg");
    const send = $("#send");
    const meLabel = $("#meLabel");
    const menuBtn = $("#menuBtn");
    const menuPanel = $("#menuPanel");
    const modeBadge = document.getElementById('modeBadge');
    const overlayBusy = document.getElementById('overlayBusy');

    let messagesCache = [];

    function setBadge(txt, bg){ modeBadge.textContent = txt; modeBadge.style.background = bg; }

    function setUIBusy(b){
      try{ send.disabled = !!b; msg.disabled = !!b; }catch{}
      overlayBusy.style.display = b ? 'flex' : 'none';
    }

    function sanitizeRoom(r){ return (r||'').toString().trim().toLowerCase().replace(/[^a-z0-9-_]/g,'-') || 'umum'; }
    function getRoom(){
      const url = new URL(location.href);
      const q = url.searchParams.get('room');
      const stored = localStorage.getItem('CHAT_ROOM');
      return sanitizeRoom(q || stored || 'umum');
    }
    function setRoom(r){
      const norm = sanitizeRoom(r);
      localStorage.setItem('CHAT_ROOM', norm);
      const url = new URL(location.href);
      url.searchParams.set('room', norm);
      location.href = url.toString();
    }

    let ROOM = getRoom();
    let NAME = localStorage.getItem("CHAT_NAME") || "";
    meLabel.textContent = `Nama: ${NAME || '-'}`;

    function askName(){
      const n = prompt("Masukkan nama (tanpa login):", NAME || "");
      if(n && n.trim()){
        NAME = n.trim();
        localStorage.setItem("CHAT_NAME", NAME);
        meLabel.textContent = "Nama: " + NAME;
      }
    }
    if(!NAME) askName();

    function fmtTime(date){
      const hh = String(date.getHours()).padStart(2,'0');
      const mm = String(date.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function addBubble(m, mine=false){
      const wrap = document.createElement('div');
      wrap.className = 'bubble ' + (mine ? 'mine' : 'theirs');
      if(!mine){
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = m.name || 'Anon';
        wrap.appendChild(nm);
      }
      const text = document.createElement('div');
      text.textContent = m.text;
      wrap.appendChild(text);
      const meta = document.createElement('div');
      meta.className = 'meta';
      const d = m.ts instanceof Date ? m.ts : new Date(m.ts || Date.now());
      const time = document.createElement('span');
      time.textContent = fmtTime(d);
      meta.appendChild(time);
      if(mine){
        const you = document.createElement('span');
        you.className = 'badge';
        you.textContent = 'You';
        meta.appendChild(you);
      }
      wrap.appendChild(meta);
      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
    }

    function systemLine(t){
      const s = document.createElement('div');
      s.className = 'sys';
      s.textContent = t;
      list.appendChild(s);
      list.scrollTop = list.scrollHeight;
    }

    function loadScript(src){
      return new Promise((res, rej)=>{
        const s = document.createElement('script'); s.src = src; s.onload = res; s.onerror = ()=>rej(new Error('load fail '+src));
        document.head.appendChild(s);
      });
    }

    class FirebaseTransport{
      constructor(room){ this.room = room; this.db = null; this.unsub = null; this.seen = new Set(); this.deleting=false; }
      async _ensure(){
        if(this.db) return;
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js');
        if(!firebase.apps || !firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
        this.db = firebase.firestore();
      }
      async listen(cb){
        await this._ensure();
        systemLine(`Ruang: ${this.room}`);
        this.unsub = this.db.collection('rooms').doc(this.room).collection('messages')
          .orderBy('ts','asc').limit(500)
          .onSnapshot({ includeMetadataChanges: true }, snap=>{
            if(this.deleting) return;
            let hasRemoval = false;
            snap.docChanges().forEach(ch=>{ if(ch.type==='removed'){ hasRemoval = true; } });
            if(hasRemoval){ this.seen.clear(); messagesCache = []; list.innerHTML=''; }
            snap.docChanges().forEach(ch=>{
              if(ch.type === 'added' || ch.type === 'modified'){
                const m = ch.doc.data();
                let tsVal = (typeof m.ts === 'number') ? m.ts : undefined;
                if(tsVal === undefined && m.serverTs && typeof m.serverTs.toDate === 'function') tsVal = m.serverTs.toDate().getTime();
                if(tsVal === undefined) tsVal = Date.now();
                const norm = { name:m.name, text:m.text, ts: tsVal };
                if(!this.seen.has(ch.doc.id)){
                  this.seen.add(ch.doc.id);
                  messagesCache.push(norm);
                  cb(norm);
                }
              }
            });
          });
      }
      async send(name, text){
        await this._ensure();
        await this.db.collection('rooms').doc(this.room).collection('messages').add({
          name,text,ts:Date.now(),serverTs:firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      async clearAll(){
        await this._ensure();
        this.deleting=true; setUIBusy(true);
        const col=this.db.collection('rooms').doc(this.room).collection('messages');
        try{
          while(true){
            const qs=await col.orderBy('ts','asc').limit(400).get({source:'server'});
            if(qs.empty) break;
            const batch=this.db.batch();
            qs.forEach(doc=>batch.delete(doc.ref));
            await batch.commit();
          }
          await this.db.waitForPendingWrites();
        }finally{
          this.seen.clear(); messagesCache=[]; list.innerHTML='';
          this.deleting=false; setUIBusy(false);
        }
        systemLine('Semua pesan di room ini sudah dihapus.');
      }
      async exportAll(){
        await this._ensure();
        const qs=await this.db.collection('rooms').doc(this.room).collection('messages').orderBy('ts','asc').get({source:'server'});
        const arr=[]; qs.forEach(doc=>{const m=doc.data(); const ts=(typeof m.ts==='number')?m.ts:(m.serverTs&&m.serverTs.toDate?m.serverTs.toDate().getTime():Date.now()); arr.push({name:m.name,text:m.text,ts});}); return arr;
      }
    }

    // DemoTransport tidak diubah
    class DemoTransport{ /* ... sama seperti sebelumnya ... */ }

    let transport = HAS_FB ? new FirebaseTransport(ROOM) : new DemoTransport(ROOM);
    if(HAS_FB){ setBadge('FIREBASE (online)', '#134e4a'); } else { setBadge('DEMO (lokal)', '#3f3f46'); }

    function addBubbleProxy(m){ addBubble(m, m.name === NAME); }
    transport.listen(addBubbleProxy);

    async function sendMsg(){ const t=msg.value.trim(); if(!t) return; if(!NAME) askName(); await transport.send(NAME||'Anon',t); msg.value=''; msg.focus(); }
    send.addEventListener('click', sendMsg);
    msg.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMsg(); });

    $('#hapusRoom').onclick=async()=>{
      if(!confirm(`Yakin hapus SEMUA pesan di room "${ROOM}"? Tindakan ini permanen.`)) return;
      try{ await transport.clearAll(); }
      catch(e){ alert('Gagal hapus. Periksa rules Firestore.'); console.error(e); }
      finally{ setUIBusy(false); }
      menuPanel.classList.remove('show');
    };
  </script>
</body>
</html>
